<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Quest√£o</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <nav class="navbar">
        <h1>üéì Educatio Quiz - Professor</h1>
        <div class ="flex items-center gap-6">
            <span th:text="${professor.nome}" style = "margin-left:"></span>
            <a href="/logout" class="btn-logout" style = >Sair</a>
        </div>
    </nav>
    
        <!-- Container Principal do Formul√°rio -->
        <div class="main-content">
            <div class="content-card">

                <!-- T√≠tulo Din√¢mico -->
                <h2 class="text-3xl font-bold mb-8 text-center" style="color: var(--accent);"
                    th:text="${questao.id_questao == null} ? 'Criar Nova Quest√£o' : 'Editar Quest√£o '">
                    Criar/Editar Quest√£o
                </h2>

                <!--
                    FORMUL√ÅRIO PRINCIPAL
                    - th:object: Liga o formul√°rio ao objeto 'questao' (vazio ou preenchido).
                    - th:action: Muda o endpoint dependendo se √© cria√ß√£o ou edi√ß√£o.
                -->
                <form th:action="${questao.id_questao == null} 
                                           ? @{/questao/salvar} 
                                           : @{/questao/atualizar}" 
                      method="post" 
                      th:object="${questao}">

                    
                    <!-- CAMPO OCULTO: ID da Quest√£o (Necess√°rio para Edi√ß√£o) -->
                    <input type="hidden" th:field="*{id_questao}" />

                    
                    <!-- CAMPO OCULTO: Professor Criador (Injetado pelo Backend) -->
                    <input type="hidden" th:field="*{professor_criador}" th:value="${professor.getId_professor()}" />

                    
                    <div style="text-align: right; margin-top: 30px;">
                        <!-- <a th:ref = "@{/questao/listar/questoes/{id}(id=${professor.id_professor})}"
                            class="btn btn-secondary mr-4"
                            title="Cancelar">Cancelar
                        </a> -->
                        <a href="javascript:void(0)" 
                           onClick="voltarParaBancoQuestoes();return false;"
                           class = "btn btn-secondary mr-4">Cancelar</a>

                        <!-- Bot√£o de Salvar (Submit) -->
                        <button type="submit" class="btn btn-primary mr-4"
                                title="Salvar Quest√£o"> Salvar <Ques></Ques>
                        </button>
                    </div>

                    
                    <!-- 1. ENUNCIADO -->
                    <div class="form-group">
                        <label for="enunciado" class="form-label">Enunciado da Quest√£o</label>
                        <textarea th:field="*{enunciado}" id="enunciado" class="form-input" rows="4" 
                            placeholder="Digite o texto da sua quest√£o, incluindo o s√≠mbolo de lacuna se for o caso."
                            required></textarea>
                        <!-- Exemplo de como exibir erro com Thymeleaf (opcional, mas recomendado) -->
                        <!-- <p th:if="${#fields.hasErrors('enunciado')}" th:errors="*{enunciado}" class="text-danger"></p> -->
                    </div>

            
                    <!-- 2. TIPO DA QUEST√ÉO -->
                    <div class="form-group">
                        <label for="tipo_questao" class="form-label">Tipo da Quest√£o</label>
                        <select th:field="*{tipo_questao}" id="tipo_questao" class="form-input"
                            onchange="toggleAlternatives()" accesskey   
                                required>
                            <option value="">Selecione o Tipo</option>
                            <option th:each="tipo : ${tiposQuestao}" th:value="${tipo}" th:text="${tipo}">Tipo de Quest√£o Exemplo</option>
                        </select>
                    </div>

                    <!-- 3. √ÅREA -->
                    <div class="form-group">
                        <label for="area" class="form-label">Tipo da Quest√£o</label>
                        <select th:field="*{area}" 
                                id="area" 
                                required 
                                class="form-input"
                                th:disabled="${questao.id_questao != null}"> <!-- Disabled na Edi√ß√£o -->
    
                            <option value="">Selecione a √Årea</option>
    
                            <!-- CORRIGIDO: Sintaxe do th:each e th:selected para pr√©-sele√ß√£o -->
                            <option th:each="areaObj : ${areasProfessor}" 
                                    th:value="${areaObj.getIdArea()}" 
                                    th:text="${areaObj.getNomeArea()}"
                                    th:selected="${questao.area != null AND questao.area == areaObj.getIdArea()}">
                            </option>
    
                        </select>
                    </div>
                    
                    <!-- O atributo th:disabled √© mantido no <select> para que ele fique cinza e n√£o edit√°vel visualmente, mas o valor enviado ser√° o do campo hidden. -->
                    <input type="hidden" th:if="${questao.id_questao != null}" th:field="*{area}" />

                    
                    <!-- 3. VISIBILIDADE -->
                    <div class="form-group">
                        <label for="visibilidade" class="form-label">Visibilidade</label>
                        <select th:field="*{visibilidade}" id="visibilidade" class="form-input" 
                            <option value="">Selecione a Visibilidade</option>
                            <option th:each="visib : ${exibicoes}" th:value="${visib}" th:text="${visib}">Visibilidade Exemplo</option>
                        </select>
                    </div>


                    <!-- 5. N√çVEL EDUCACIONAL -->
                    <div class="form-group">
                        <label for="nivel_educacional" class="form-label">N√≠vel Educacional</label>
                        <select th:field="*{nivel_educacional}" id="nivel_educacional"
                                class="form-input" required>
                            <option value="">Selecione o N√≠vel</option>
                            <option th:each="nivel : ${escolaridades}" th:value="${nivel}" th:text="${nivel}">N√≠vel Exemplo</option>
                        </select>
                    </div>

                    <!-- 6. N√çVEL DE DIFICULDADE -->
                    <div class="form-group">
                        <label for="nivel_dificuldade" class="form-label">N√≠vel de Dificuldade</label>
                        <select th:field="*{nivel_dificuldade}" id="nivel_dificuldade" 
                                class="form-input" required>
                            <option value="">Selecione a Dificuldade</option>
                            <option th:each="dificuldade : ${dificuldades}" th:value="${dificuldade}" th:text="${dificuldade}">Dificuldade Exemplo</option>
                        </select>
                    </div>


                    <!-- ======================================================= -->
                    <!-- SE√á√ïES DIN√ÇMICAS DE ALTERNATIVAS -->
                    <!-- ======================================================= -->

                    <!-- 3. SE√á√ïES DIN√ÇMICAS DE RESPOSTA (MINIMIZADAS) -->

                    <!-- SE√á√ÉO M√öLTIPLA ESCOLHA -->
                    <h3 style="color: var(--accent); font-size: 1.1rem; margin-top: 20px;">Defini√ß√£o da Resposta</h3>
                    
                    <div id="multipla-escolha-section" style="display:none; padding: 15px; border: 1px dashed #2e3542; border-radius: 8px; margin-top: 10px;">
                        <p class="form-label" style="color: #9da5b4;">Alternativas (5 Fixas). Selecione apenas uma como Correta.</p>

                        <div th:each="i : ${#numbers.sequence(0, 4)}" class="alternativa-item flex gap-2 items-center" style="margin-bottom: 10px;">
                            <!-- Input Texto: alternativas[i].texto_alternativa -->
                            <div th:each="j : ${#numbers.sequence(0, 4)}">
                            <!-- Campo oculto para garantir que as outras sejam 'N' //Tirar se estiver causand o problema -->
                                <input type="hidden" th:name="${'alternativas[' + j + '].flg_eh_correta'}" value="N">
                            </div>
                            
                            <input type="text" 
                                   th:id="${'alt_M_' + i}" 
                                   th:field="*{alternativas[__${i}__].texto_alternativa}" 
                                   class="form-input" style="flex-grow: 1;" placeholder="Texto da Alternativa">

                            <!-- Radio para Corre√ß√£o: alternativas[i].flg_eh_correta -->
                            <input type="radio" th:id="${'radio_M_' + i}" 
                                   th:field="*{alternativas[__${i}__].flg_eh_correta}" 
            th:checked="${questao.alternativas[__${i}__].flg_eh_correta == 'S'}" 
                                   value="S" style="width: 20px; height: 20px;">
                            <label th:for="${'radio_M_' + i}" style="color: var(--accent);">Correta</label>

                        </div>
                    </div>

                    <!-- SE√á√ÉO VERDADEIRO OU FALSO -->
                    <div id="verdadeiro-falso-section" style="display:none; padding: 15px; border: 1px dashed #2e3542; border-radius: 8px; margin-top: 10px;">
                        <p class="form-label" style="color: #9da5b4;">Afirma√ß√µes V/F (5 Fixas). Marque V ou F para cada afirma√ß√£o.</p>

                        <div th:each="i : ${#numbers.sequence(0, 4)}" class="alternativa-item flex gap-2 items-center" style="margin-bottom: 10px;">
                            
                            <input type="text" th:id="${'alt_VF_' + i}" 
                                   th:field="*{alternativas[__${i}__].texto_alternativa}"
                                   class="form-input" style="flex-grow: 1;" 
                                   placeholder="Texto da Afirma√ß√£o (V ou F)">

                            <!-- Radio V (Correta = S) -->
                            <input type="radio" th:id="${'radio_V_' + i}" 
                                   th:field="*{alternativas[__${i}__].flg_eh_correta}" 
                                th:checked="${questao.alternativas[__${i}__].flg_eh_correta == 'S'}"
                                   value="S" style="width: 20px; height: 20px;">
                            <label th:for="${'radio_V_' + i}" style="color: #00c26e;">V</label>

                            <!-- Radio F (Correta = N) -->
                            <input type="radio" th:id="${'radio_F_' + i}" 
                                   th:field="*{alternativas[__${i}__].flg_eh_correta}" 
            th:checked="${questao.alternativas[__${i}__].flg_eh_correta == 'N'}"
                                   value="N"
                                   style="width: 20px; height: 20px;">
                            <label th:for="${'radio_F_' + i}" style="color: #EF4444;">F</label>

                            <!-- Campo oculto para garantir que o Spring n√£o ignore nenhuma posi√ß√£o do array -->
                            <!-- <input type="hidden" th:name="${'alternativas[' + i + '].flg_eh_correta'}" value="N"> -->
                            
                            <!-- Campo oculto para garantir que o Spring n√£o ignore nenhuma posi√ß√£o do array -->
                            <!-- NOTE: N√£o √© mais necess√°rio com th:field, mas mantido como backup de valor inicial 'N' //Mudar de volta se n√£o funcionar-->
                            <input type="hidden" th:if="${!#strings.equals(questao.alternativas[__${i}__].flg_eh_correta, 'S') and !#strings.equals(questao.alternativas[__${i}__].flg_eh_correta, 'N')}"
                                   th:name="${'alternativas[' + i + '].flg_eh_correta'}" value="N">
                        </div>
                    </div>

                    
                    <!-- SE√á√ÉO PREENCHER LACUNA -->
                    <div id="preencher-lacuna-section" style="display:none; padding: 15px; border: 1px dashed #2e3542; border-radius: 8px; margin-top: 10px;">
                        <div class="form-group">
                            <label for="resposta_lacuna" class="form-label"> Resposta Exata da Lacuna </label>


                            <textarea id="resposta_lacuna" 
                                      th:field="*{alternativas[0].texto_alternativa}" 
                                      rows="2" class="form-input" 
                                      placeholder="Palavra ou frase exata esperada."></textarea>

                            <!-- Campo oculto para dizer que esta √∫nica resposta √© a correta -->
                            <input type="hidden" th:field="*{alternativas[0].flg_eh_correta}" value="S">
                        </div>
                    </div>

                </form>
            </div>
        </div>
                    
    
    <script>
        function toggleAlternatives() {
            const tipo = document.getElementById('tipo_questao').value;

            const mc = document.getElementById('multipla-escolha-section');
            const vf = document.getElementById('verdadeiro-falso-section');
            const lacuna = document.getElementById('preencher-lacuna-section');

            if (mc) mc.style.display = 'none';
            if (vf) vf.style.display = 'none';
            if (lacuna) lacuna.style.display = 'none';

            if (tipo === 'Multipla Escolha' && mc) {
                mc.style.display = 'block';
            } else if (tipo === 'Verdadeiro ou Falso' && vf) {
                vf.style.display = 'block';
            } else if (tipo === 'Preencher Lacuna' && lacuna) {
                lacuna.style.display = 'block';
            }
        }

        
        function voltarParaBancoQuestoes(){
            const paginaAnterior = document.referrer;
            
            if (paginaAnterior.includes('/listar/questoes/')) {
                // Se a p√°gina anterior for 'X', volta 1 passo.
                history.go(-1);

              // Substitua 'URL_COMPLETA_DE_Y' pela URL exata da sua p√°gina Y
              } else if (paginaAnterior.includes('questao/buscar/')) {
                // Se a p√°gina anterior for 'Y', volta 2 passos.
                // O pressuposto aqui √© que voc√™ est√° em Z -> Y -> X, e quer voltar para X
                history.go(-2);
        }

            
        // Inicializa√ß√£o da L√≥gica de Exibi√ß√£o de Alternativas no carregamento
        document.addEventListener('DOMContentLoaded', function() {
            // A fun√ß√£o toggleAlternatives() √© chamada para exibir a se√ß√£o que foi preenchida pelo Thymeleaf
            toggleAlternatives(); 
        });
            
        document.addEventListener('DOMContentLoaded', function() {
            // A fun√ß√£o toggleAlternatives() √© chamada para exibir a se√ß√£o que foi preenchida pelo Thymeleaf
            toggleAlternatives(); 
        });

        //N√£o est√° funcionando
        // document.addEventListener('DOMContentLoaded', function() {

        //         // 2. Executa a fun√ß√£o das Alternativas para mostrar a se√ß√£o correta
        //         // Isso garante que, se houver um tipo de quest√£o preenchido (modo EDI√á√ÉO), 
        //         // a se√ß√£o correspondente seja exibida imediatamente.
        //         toggleAlternatives(); 

        //         // 3. Pr√©-seleciona a Resposta Correta nos Dropdowns (M√∫ltipla Escolha / V/F)
        //         const tipo = document.getElementById('tipo_questao').value;

        //         // S√≥ faz sentido tentar preencher a resposta correta se for EDI√á√ÉO e a quest√£o tiver alternativas.
        //         if ('[[${questao.id_questao}]]' !== '') {

        //             if (tipo === 'Multipla Escolha' || tipo === 'Verdadeiro ou Falso') {
        //                 // Esta l√≥gica precisa ser ajustada, pois o THYMELEAF DEVE PREENCHER DIRETO.
        //                 // O valor 'resposta_mc' e 'resposta_vf' deve ser preenchido por um atributo th:value no HTML

        //                 // Exemplo de como o Thymeleaf preencheria o dropdown de resposta:
        //                 // O Controller precisa enviar o 'letraResposta' (ex: 'C') para ser preenchido aqui.

        //                 // Se estiver usando o ID tempor√°rio 'resposta_mc' para a letra:
        //                 const letraCorreta = '[[${letraDaAlternativaCorreta}]]'; // Vari√°vel do Controller
        //                 if (document.getElementById('resposta_mc')) {
        //                     document.getElementById('resposta_mc').value = letraCorreta;
        //                 }
        //                 if (document.getElementById('resposta_vf')) {
        //                     document.getElementById('resposta_vf').value = letraCorreta;
        //                 }
        //             }
        //         }
        //     });
    </script>                            
</body>
</html>