<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Desempenho</title>
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <link rel="stylesheet" th:href="@{/css/fluxo_aluno.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <h1>üéì Educatio Quiz - Aluno</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span th:text="${aluno.nome}"></span>
            <a href="/logout" class="btn-logout">Sair</a>
        </div>
    </nav>

    <main class="main-content">
        <div class="content-card">
            
            <div class="quiz-header">
                <h2 class="text-xl font-bold" style="color: var(--text-light);">Dashboard de Desempenho</h2>
                <a href="/aluno/home" class="btn btn-secondary">‚¨ÖÔ∏è Voltar</a>
            </div>

            <div class="filter-bar" style="margin-bottom: 2rem;">
                <label style="color: var(--text-muted); font-weight: 600; margin-right: 10px;">Filtrar:</label>
                
                <select name="areaId" class="form-select search-filter-select" onchange="atualizarDashboard()">
                    <option value="">Todas as √Åreas</option>
                    <option th:each="area : ${areas}" 
                            th:value="${area.idArea}" 
                            th:text="${area.nomeArea}"
                            th:selected="${area.idArea == areaSelecionada}">
                    </option>
                </select>

                <select name="periodo" class="form-select search-filter-select" onchange="atualizarDashboard()">
                    <option value="all">Todo o Per√≠odo</option>
                    <option value="30d">√öltimos 30 Dias</option>
                    <option value="7d">√öltima Semana</option>
                </select>
            </div>

            <div class="kpi-grid">
                <div class="kpi-box">
                    <div style="color: var(--text-muted);">Quizzes Realizados</div>
                    <div class="kpi-number" id="kpiTotalQuizzes" th:text="${totalQuizzes}">0</div>
                </div>
                <div class="kpi-box">
                    <div style="color: var(--text-muted);">M√©dia Geral</div>
                    <div class="kpi-number" id="kpiMediaGeral" th:text="${mediaGeral} + '%'">0%</div>
                </div>
            </div>

            <div class="content-card" style="background: #161b22; margin-bottom: 2rem; box-shadow: none; border: 1px solid #30363d;">
                <h3 style="color: var(--text-light); margin-bottom: 1rem;">üìà Evolu√ß√£o de Notas</h3>
                <div class="chart-scroll-container">
                    <div class="chart-wrapper" id="lineChartWrapper">
                        <canvas id="chartEvolucao"></canvas>
                    </div>
                </div>
            </div>

            <div class="content-card" style="background: #161b22; box-shadow: none; border: 1px solid #30363d;">
                <h3 style="color: var(--text-light); margin-bottom: 1rem;">üìä Desempenho por Dificuldade</h3>
                <div style="height: 300px; width: 100%;">
                    <canvas id="chartDificuldade"></canvas>
                </div>
            </div>

        </div>
    </main>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const dadosIniciaisH = /*[[${dadosGraficoLinha}]]*/ [];
        const dadosIniciaisD = /*[[${dadosGraficoDificuldade}]]*/ [];

        let chartEvolucao = null;
        let chartDificuldade = null;

        function renderizarGraficoEvolucao(historico) {
            const ctx = document.getElementById('chartEvolucao');
            const wrapper = document.getElementById('lineChartWrapper');
            
            // Largura din√¢mica para scroll
            const minWidth = 800;
            const dynamicWidth = Math.max(minWidth, historico.length * 70);
            wrapper.style.width = dynamicWidth + 'px';

            const labels = historico.map(h => h.labelData + ' - ' + (h.quizTitulo.length > 15 ? h.quizTitulo.substring(0,15)+'...' : h.quizTitulo));
            const valores = historico.map(h => h.porcentagem > 100 ? 100 : h.porcentagem);

            if (chartEvolucao) chartEvolucao.destroy();

            chartEvolucao = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nota (%)',
                        data: valores,
                        borderColor: '#00c26e',
                        backgroundColor: 'rgba(0, 194, 110, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#161b22',
                        pointBorderColor: '#00c26e',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: '#30363d' }, ticks: { color: '#9da5b4' } },
                        x: { grid: { color: '#30363d' }, ticks: { color: '#9da5b4' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderizarGraficoDificuldade(dadosDif) {
            const ctx = document.getElementById('chartDificuldade');
            const ordem = ['F√ÅCIL', 'M√âDIO', 'DIFICIL', 'DIF√çCIL'];
            const cores = { 'F√ÅCIL': '#00c26e', 'M√âDIO': '#ffc107', 'DIFICIL': '#da3633', 'DIF√çCIL': '#da3633' };
            
            dadosDif.sort((a, b) => ordem.indexOf(a.label.toUpperCase()) - ordem.indexOf(b.label.toUpperCase()));
            const labels = dadosDif.map(s => s.label);
            const valores = dadosDif.map(s => s.valor);
            const bgColors = dadosDif.map(s => cores[s.label.toUpperCase()] || '#30363d');

            if (chartDificuldade) chartDificuldade.destroy();

            chartDificuldade = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ data: valores, backgroundColor: bgColors, borderRadius: 4 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100, grid: { color: '#30363d' }, ticks: { color: '#9da5b4' } },
                        y: { grid: { display: false }, ticks: { color: '#f5f5f5', font: {weight:'bold'} } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function atualizarDashboard() {
            const areaId = document.querySelector('select[name="areaId"]').value;
            const periodo = document.querySelector('select[name="periodo"]').value;
            
            fetch(`/aluno/api/desempenho-dados?areaId=${areaId}&periodo=${periodo}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('kpiTotalQuizzes').innerText = data.totalQuizzes;
                    document.getElementById('kpiMediaGeral').innerText = data.mediaGeral + '%';
                    renderizarGraficoEvolucao(data.historico);
                    renderizarGraficoDificuldade(data.dificuldade);
                });
        }

        renderizarGraficoEvolucao(dadosIniciaisH);
        renderizarGraficoDificuldade(dadosIniciaisD);
        /*]]>*/
    </script>
</body>
</html>