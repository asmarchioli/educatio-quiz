<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Desempenho | Educatio</title>
    <link rel="stylesheet" th:href="@{/css/global2.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos Gerais */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* --- CORRE√á√ÉO DO GR√ÅFICO (Scroll Horizontal Est√°vel) --- */
        .chart-scroll-wrapper {
            width: 100%;
            overflow-x: auto; 
            padding-bottom: 15px; /* Espa√ßo para a barra de rolagem */
            display: block;
        }
        
        .chart-container-inner {
            height: 350px; /* Altura FIXA para evitar pulos */
            position: relative;
            /* A largura ser√° definida dinamicamente pelo JS */
        }
        
        /* For√ßa o canvas a preencher o container interno (que tem altura fixa) */
        .chart-container-inner canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Scrollbar bonita (opcional) */
        .chart-scroll-wrapper::-webkit-scrollbar { height: 8px; }
        .chart-scroll-wrapper::-webkit-scrollbar-track { background: #1a1f27; }
        .chart-scroll-wrapper::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">üéì Educatio</div>
        <div class="navbar-user">
            <span class="user-name" th:text="${aluno.nome}">Aluno</span>
            <a href="/logout" class="btn btn-sm btn-danger">Sair</a>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">Dashboard de Desempenho</h1>
            <a href="/aluno/home" class="btn btn-secondary">‚¨Ö Voltar</a>
        </div>

        <!-- Filtros -->
        <div class="card" style="margin-bottom: 2rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <span style="font-weight: 600; color: var(--text-white);">Filtrar por:</span>
            
            <select name="areaId" class="form-control" style="width: 200px;" onchange="atualizarDashboard()">
                <option value="">Todas as √Åreas</option>
                <option th:each="area : ${areas}" 
                        th:value="${area.idArea}" 
                        th:text="${area.nomeArea}"
                        th:selected="${area.idArea == areaSelecionada}">
                </option>
            </select>

            <select name="periodo" class="form-control" style="width: 180px;" onchange="atualizarDashboard()">
                <option value="all">Todo o Per√≠odo</option>
                <option value="30d">√öltimos 30 Dias</option>
                <option value="7d">√öltima Semana</option>
            </select>
        </div>

        <!-- KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div style="color: var(--text-muted); margin-bottom: 0.5rem;">Quizzes Realizados</div>
                <div class="kpi-value" id="kpiTotalQuizzes" th:text="${totalQuizzes}">0</div>
            </div>
            <div class="kpi-card">
                <div style="color: var(--text-muted); margin-bottom: 0.5rem;">M√©dia de Aproveitamento</div>
                <div class="kpi-value" id="kpiMediaGeral" th:text="${mediaGeral} + '%'">0%</div>
            </div>
        </div>

        <!-- Gr√°fico Evolu√ß√£o -->
        <div class="chart-container">
            <h3 style="color: var(--text-white); margin-bottom: 1rem;">Evolu√ß√£o de Notas</h3>
            <div class="chart-scroll-wrapper">
                <div class="chart-container-inner" id="lineChartContainer">
                    <canvas id="chartEvolucao"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√°fico Dificuldade -->
        <div class="chart-container">
            <h3 style="color: var(--text-white); margin-bottom: 1rem;">Desempenho por Dificuldade</h3>
            <div style="height: 300px;">
                <canvas id="chartDificuldade"></canvas>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const dadosIniciaisH = /*[[${dadosGraficoLinha}]]*/ [];
        const dadosIniciaisD = /*[[${dadosGraficoDificuldade}]]*/ [];

        let chartEvolucao = null;
        let chartDificuldade = null;

        function renderizarGraficoEvolucao(historico) {
            const ctx = document.getElementById('chartEvolucao');
            const container = document.getElementById('lineChartContainer');
            
            // === L√ìGICA DE LARGURA FIXA E SUAVE ===
            const minWidthPerPoint = 80; 
            const scrollWrapper = document.querySelector('.chart-scroll-wrapper');
            // Usa a largura dispon√≠vel da tela como base m√≠nima
            const containerWidth = scrollWrapper ? scrollWrapper.clientWidth : 800; 
            
            // A largura ser√° o MAIOR valor entre: "Largura da Tela" E "Total de Pontos * 80px"
            // Isso garante que com poucos pontos ele preencha a tela, e com muitos ele ative o scroll.
            const newWidth = Math.max(containerWidth, historico.length * minWidthPerPoint);
            
            container.style.width = newWidth + 'px';

            const labels = historico.map(h => {
                let titulo = h.quizTitulo;
                if (titulo.length > 20) titulo = titulo.substring(0, 20) + '...';
                return h.labelData + ' - ' + titulo;
            });
            
            const valores = historico.map(h => h.porcentagem > 100 ? 100 : h.porcentagem);

            if (chartEvolucao) chartEvolucao.destroy();

            chartEvolucao = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nota (%)',
                        data: valores,
                        borderColor: '#238636',
                        backgroundColor: 'rgba(35, 134, 54, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#161b22',
                        pointBorderColor: '#238636',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CRUCIAL para o scroll funcionar sem achatar
                    layout: {
                        padding: { top: 10, right: 20, bottom: 10, left: 10 }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100, 
                            grid: { color: '#30363d' }, 
                            ticks: { color: '#8b949e' } 
                        },
                        x: { 
                            grid: { color: '#30363d' }, 
                            ticks: { 
                                color: '#8b949e', 
                                maxRotation: 45, 
                                minRotation: 45 
                            } 
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const i = items[0].dataIndex;
                                    const item = historico[i];
                                    // Tooltip completo
                                    return item.labelData + ' | ' + item.quizTitulo + ' (' + item.tentativa + '¬™ Tentativa)';
                                },
                                label: (ctx) => `Nota: ${ctx.raw.toFixed(1)}%`
                            },
                            backgroundColor: 'rgba(22, 27, 34, 0.95)',
                            titleFont: { size: 13 },
                            bodyFont: { size: 13 },
                            padding: 10,
                            borderColor: '#238636',
                            borderWidth: 1,
                            displayColors: false
                        }
                    }
                }
            });
        }

        function renderizarGraficoDificuldade(dadosDif) {
            const ctx = document.getElementById('chartDificuldade');
            const ordem = ['F√ÅCIL', 'M√âDIO', 'DIFICIL', 'DIF√çCIL'];
            const cores = { 'F√ÅCIL': '#238636', 'M√âDIO': '#d29922', 'DIFICIL': '#da3633', 'DIF√çCIL': '#da3633' };
            
            dadosDif.sort((a, b) => ordem.indexOf(a.label.toUpperCase()) - ordem.indexOf(b.label.toUpperCase()));
            const labels = dadosDif.map(s => s.label);
            const valores = dadosDif.map(s => s.valor);
            const bgColors = dadosDif.map(s => cores[s.label.toUpperCase()] || '#30363d');

            if (chartDificuldade) chartDificuldade.destroy();

            chartDificuldade = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ data: valores, backgroundColor: bgColors, borderRadius: 4 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100, grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
                        y: { grid: { display: false }, ticks: { color: '#c9d1d9', font: {weight:'bold'} } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function atualizarDashboard() {
            const areaId = document.querySelector('select[name="areaId"]').value;
            const periodo = document.querySelector('select[name="periodo"]').value;
            
            fetch(`/aluno/api/desempenho-dados?areaId=${areaId}&periodo=${periodo}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('kpiTotalQuizzes').innerText = data.totalQuizzes;
                    document.getElementById('kpiMediaGeral').innerText = data.mediaGeral + '%';
                    renderizarGraficoEvolucao(data.historico);
                    renderizarGraficoDificuldade(data.dificuldade);
                });
        }

        // Renderiza inicial com dados do thymeleaf
        renderizarGraficoEvolucao(dadosIniciaisH);
        renderizarGraficoDificuldade(dadosIniciaisD);

        /*]]>*/
    </script>
</body>
</html>