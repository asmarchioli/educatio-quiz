<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educatio Quiz - Gerenciamento de Quest√µes</title>
    <!-- <link rel="stylesheet" th:href="@{/css/style.css}"> -->
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <link rel="stylesheet" th:href="@{/css/fluxo_professor.css}">
</head>
<body>
    <nav class="navbar">
        <h1>üéì Educatio Quiz - Professor</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span th:text="${professor.nome}"></span>
            <a href="/logout" class="btn-logout">Sair</a>
        </div>
    </nav>

    <!-- CONTE√öDO PRINCIPAL (Tabela) -->
    <main class="main-content">
        <div class="content-card">

            <!-- T√≠tulo da √Årea e Bot√£o de Cria√ß√£o -->
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-semibold" style="color: var(--text-light);">
                    Gerenciamento de Quest√µes
                </h2>
                
                <div th:if="${quizId == null}">
                    <!-- Bot√£o de Voltar/Cancelar -->
                    <a href="/professor/home"         
                        class="btn btn-secondary ">
                        ‚¨ÖÔ∏è Voltar para Menu Inicial
                    </a>
                    
                    <!-- Bot√£o de Cria√ß√£o -->
                    <a href="/questao/novo" class="btn btn-primary font-semibold">
                    <!-- <a href="/professor/criar_questao" class="btn btn-primary font-semibold"> -->
                        ‚ûï Criar Nova Quest√£o
                    </a>
                </div>
            </div>

            <!-- BARRA DE PESQUISA EST√ÅTICA -->
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar enunciado da quest√£o..."
                       class="form-input search-input"
                >
                <div class="search-icon">
                    <!-- √çcone de Lupa -->
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- Tabela Responsiva de Quest√µes -->
            <div class="table-container">
                <table class="dark-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">Tipo</th>
                            <th style="width: 45%;">Enunciado</th>
                            <th style="width: 15%;">N√≠vel</th>
                            <th class="text-center" style="width: 10%;">Dificuldade</th>
                            <th class="text-center" style="width: 15%;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="questao : ${questoes}">
                            <td th:text="${questao.tipo_questao}"></td>
                            <td th:text="${questao.enunciado}"
                                style="max-width: 350px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                
                            </td>
                            <td th:text="${questao.nivel_educacional}" class="text-center"></td>
                            <td th:text="${questao.nivel_dificuldade}" class="text-center text-accent" ></td>

                            <!-- Bot√µes de a√ß√£o  -->
                            <td class="actions-cell"> 

                                <div th:if="${quizId != null}" class="flex-column-buttons">
                                    <form th:action="@{/quiz/adicionar/questao}" method="post" class="inline-block"> 
                                        <input type="hidden" name="id_questao" th:value="${questao.id_questao}" />
                                        <input type="hidden" name="id_quiz" th:value="${quizId}" />
                                        <button type="submit" class="table-action-btn btn-primary">
                                            ‚ûï
                                        </button>
                                    </form>
                                </div>

                                <div th:if="${quizId == null}" class="flex-column-buttons"> 

                                    <a th:href="@{/questao/buscar/{id}(id=${questao.id_questao})}"
                                       class="table-action-btn btn-details"
                                       data-toggle="page">
                                        Detalhes
                                    </a>

                                    <a th:href="@{/questao/editar/{id}(id=${questao.getId_questao()})}"
                                       class="table-action-btn btn-edit">
                                        Editar
                                    </a>

                                    <form th:action="@{/questao/excluir}" method="post" class="inline-block"> 
                                        <input type="hidden" name="id_questao" th:value="${questao.id_questao}" />
                                        <button type="submit" class="table-action-btn btn-danger-table"> 
                                            Excluir
                                        </button>
                                    </form>

                                </div>
                            </td>
                            <!-- alguma dessas classes deve estar quebrando a tabela -->
                            <!-- <td class="flex items-center space-x-1-2"> 
                                <div class="flex-column-buttons">


                                    <a th:if="history.back() = ''""></a>
                                    <a th:href="@{/questao/buscar/{id}(id=${questao.id_questao})}"
                                       class="table-action-btn btn-details"
                                       data-toggle="page">
                                        Detalhes
                                    </a>
  
                                    <a th:href="@{/questao/editar/{id}(id=${questao.getId_questao()})}"
                                       class="table-action-btn btn-edit">
                                        Editar
                                    </a>

                                    <form th:action="@{/questao/excluir}" 
                                          method="post"
                                    >
                                        <input type="hidden" name="id_questao" th:value="${questao.id_questao}" />
                                        <button type="submit" class="btn btn-danger">
                                            Excluir
                                        </button>
                                    </form>
                                </div>
                            </td> -->
                            
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Fim da Tabela -->

        </div>
    </main>

    <!-- Rodap√© opcional -->
    <footer class="main-content" style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem;">
        &copy; 2024 Educatio Quiz. Todos os direitos reservados.
    </footer>


    <!-- ============================================== -->
    <!-- MODAL DE DETALHES DA QUEST√ÉO (M√≠nimo JS) -->
    <!-- ============================================== -->
    <div id="details-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3 class="font-bold">Detalhes da Quest√£o <span id="detail-id"></span></h3>

            <!-- CORPO DO FORMUL√ÅRIO / INFORMA√á√ïES B√ÅSICAS -->
            <div class="modal-details-body">

                <div class="modal-info-group">
                    <strong>Tipo de Quest√£o</strong>
                    <p id="detail-tipo"></p>
                </div>

                <div class="modal-info-group">
                    <strong>Enunciado</strong>
                    <p id="detail-enunciado"></p>
                </div>

                <div class="modal-info-group">
                    <strong>N√≠vel / Dificuldade</strong>
                    <!-- N√≠vel Educacional (ID NECESS√ÅRIO) -->
                    <p>N√≠vel: <span id="detail-nivel"></span></p> 
                    <!-- N√≠vel de Dificuldade (ID NECESS√ÅRIO) -->
                    <p>Dificuldade: <span id="detail-dificuldade"></span></p> 
                </div>

                <div class="modal-info-group">
                    <strong>Professor Criador</strong>
                    <p id="detail-criador"></p>
                </div>

                <div class="modal-info-group">
                    <strong>Resposta Correta</strong>
                    <!-- ID NECESS√ÅRIO: Usado para tipos de quest√£o est√°ticos (o JS tenta preencher isso) -->
                    <p id="detail-resposta"></p> 
                </div>

                <!-- SE√á√ÉO DE ALTERNATIVAS (Carregada via AJAX) -->
                <div id="detail-alternativas-container" class="modal-alternatives" style="margin-top: 1.5rem;">
                    <!-- T√≠tulo da se√ß√£o, Carregamento e Dados injetados ficam aqui -->
                    <h4 class="detail-subtitle" style="font-weight: 600; font-size: 1.1rem; color: var(--text-light); margin-bottom: 1rem;">Alternativas:</h4>
                    <div id="alternativas-loading" style="text-align: center; color: var(--accent);">Carregando alternativas...</div>
                    <div id="alternativas-data">
                        <!-- Conte√∫do injetado pelo JS (injectAlternatives) -->
                    </div>
                </div>

            </div>

            <!-- RODAP√â E BOT√ïES DO MODAL -->
            <div class="flex justify-between items-center" style="margin-top: 2rem;">
                <button onclick="closeDetails()" class="btn btn-secondary">
                    Fechar
                </button>
                <div class="flex space-x-1-2">
                    <a href="#" class="btn-primary table-action-btn btn-edit" style="padding: 0.75rem 1.5rem;">
                        Editar Quest√£o
                    </a>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ==============================================
        // DADOS SIMULADOS (Minimal JS)
        // ==============================================
        // const questionsData = [
        //     {
        //         id: 1,
        //         type: "M√∫ltipla Escolha",
        //         statement: "Qual √© a fun√ß√£o principal das mitoc√¥ndrias na c√©lula?",
        //         level: "Superior",
        //         difficulty: "F√°cil",
        //         creator: "Prof. Alberto Santos",
        //         answer: "Produ√ß√£o de ATP (energia).",
        //         alternatives: [
        //             "S√≠ntese de prote√≠nas.",
        //             "Transporte de subst√¢ncias.",
        //             "Produ√ß√£o de ATP (energia).", // Correta
        //             "Armazenamento de √°gua."
        //         ]
        //     },
        //     {
        //         id: 2,
        //         type: "Preencher Lacuna",
        //         statement: "O dobro de 10 √© ___.",
        //         level: "Fundamental I",
        //         difficulty: "F√°cil",
        //         creator: "Prof. Julia Almeida",
        //         answer: "20",
        //         alternatives: null
        //     },
        //     {
        //         id: 3,
        //         type: "Dissertativa",
        //         statement: "Explique a Segunda Lei da Termodin√¢mica em 100 palavras.",
        //         level: "Superior",
        //         difficulty: "Dif√≠cil",
        //         creator: "Prof. Ana Carvalho",
        //         answer: "A Segunda Lei da Termodin√¢mica afirma que a entropia total de um sistema isolado (e a sua vizinhan√ßa) nunca pode diminuir ao longo do tempo. Em outras palavras, processos naturais espont√¢neos tendem a mover-se em uma dire√ß√£o que aumenta o grau de desordem (entropia) do universo. √â por isso que o calor flui espontaneamente de um corpo quente para um corpo frio, mas nunca o contr√°rio.",
        //         alternatives: null
        //     }
        // ];

        // document.addEventListener('DOMContentLoaded', (event) => {
        //     // Inicializa a visibilidade no carregamento da p√°gina
        //     toggleAlternatives(); 
        // });

        // function toggleAlternatives() {
        //     const typeSelect = document.getElementById('tipo_questao');
        //     const alternativesSection = document.getElementById('alternatives-section');
        //     const alternativeInputs = document.querySelectorAll('.alt-input');

        //     // Simula√ß√£o: Se o valor for '1' (M√∫ltipla Escolha), exibe as alternativas.
        //     const isMultipleChoice = typeSelect.value === '1';

        //     if (isMultipleChoice) {
        //         alternativesSection.style.display = 'block';
        //         // Define os campos de alternativa como obrigat√≥rios (required)
        //         alternativeInputs.forEach(input => {
        //             input.required = true;
        //         });
        //     } else {
        //         alternativesSection.style.display = 'none';
        //         // Remove a obrigatoriedade dos campos
        //         alternativeInputs.forEach(input => {
        //             input.required = false;
        //         });
        //     }
        // }
        
        // ==============================================
        // FUN√á√ïES DE CONTROLE DO MODAL
        // ==============================================

        // const modal = document.getElementById('details-modal');
        // const modalContent = document.querySelector('.modal-content');
        // const altContainer = document.getElementById('detail-alternatives-container');
        // const altList = document.getElementById('detail-alternatives');

        // function showDetails(id) {
        //     // 1. Encontra a linha da tabela correspondente ao ID
        //     const row = document.querySelector(`tr[data-id="${id}"]`);
        //     if (!row) {
        //         console.error(`Quest√£o com ID ${id} n√£o encontrada na tabela.`);
        //         return;
        //     }

        //     // 2. Extrai os dados dos atributos 'data-'
        //     const enunciado = row.getAttribute('data-enunciado');
        //     const tipo = row.getAttribute('data-tipo');
        //     const nivel = row.getAttribute('data-nivel');
        //     const dificuldade = row.getAttribute('data-dificuldade');
        //     const criador = row.getAttribute('data-criador');

        //     // O campo data-resposta-correta foi removido, agora focamos apenas nas alternativas
        //     // Para Preencher Lacuna, a resposta √© o pr√≥prio enunciado da alternativa correta.

        //     const alternativesJson = row.getAttribute('data-alternativas'); 
        //     let alternatives = null;

        //     // Converte o JSON de alternativas em um objeto JavaScript (List<Alternativa>)
        //     if (alternativesJson && alternativesJson !== '[]') {
        //         try {
        //             alternatives = JSON.parse(alternativesJson);
        //         } catch (e) {
        //             console.error("Erro ao parsear JSON de alternativas:", e);
        //         }
        //     }

        //     // Elementos do Modal
        //     const modal = document.getElementById('details-modal');
        //     const altContainer = document.getElementById('alternatives-container');
        //     const altList = document.getElementById('alternatives-list');

        //     // 3. Preenche os campos principais do modal
        //     document.getElementById('detail-id').textContent = `#${id}`;
        //     document.getElementById('detail-type').textContent = tipo;
        //     document.getElementById('detail-statement').textContent = enunciado;
        //     document.getElementById('detail-level').textContent = nivel;
        //     document.getElementById('detail-difficulty').textContent = dificuldade;
        //     document.getElementById('detail-creator').textContent = criador;

        //     // Vari√°veis para preencher a Resposta Correta (depende do tipo)
        //     let respostaTexto = 'N/A'; 
        //     let respostaLabel = ''; // A, B, C, D...

        //     // Zera e esconde a se√ß√£o de alternativas por padr√£o
        //     altList.innerHTML = '';
        //     altContainer.style.display = 'none';

        //     // 4. L√≥gica das Alternativas
        //     if (alternatives && alternatives.length > 0) {

        //         const labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

        //         if (tipo === 'Preencher Lacuna') {
        //              // Para Lacuna, a resposta √© o texto da √∫nica alternativa correta
        //             const correctAlt = alternatives.find(alt => alt.flg_eh_correta === 'S');
        //             if (correctAlt) {
        //                 respostaTexto = correctAlt.texto_alternativa;
        //             }
        //             // N√£o listamos as alternativas para Lacuna
        //             altContainer.style.display = 'none';

        //         } else {
        //             // Multipla Escolha ou Verdadeiro ou Falso
        //             altContainer.style.display = 'block';

        //             alternatives.forEach((alt, index) => {
        //                 if (index >= labels.length) return; 

        //                 const listItem = document.createElement('li');
        //                 listItem.classList.remove('correct-answer');

        //                 let altText = alt.texto_alternativa; 
        //                 let isCorrect = alt.flg_eh_correta === 'S'; // Usa a flag 'S' ou 'N'

        //                 if (tipo === 'Verdadeiro ou Falso') {
        //                     // Adiciona o status Verdadeiro/Falso ao texto
        //                     altText += isCorrect ? ' (VERDADEIRO)' : ' (FALSO)';
        //                 }

        //                 // Define o conte√∫do da lista
        //                 listItem.textContent = `${labels[index]}. ${altText}`;

        //                 if (isCorrect) {
        //                     listItem.classList.add('correct-answer');

        //                     // Captura a label correta para exibir no campo "Resposta"
        //                     respostaLabel = labels[index]; 

        //                     // Se for V/F, a resposta √© sempre 'VERDADEIRO' ou o texto da afirma√ß√£o
        //                     if (tipo === 'Verdadeiro ou Falso') {
        //                          respostaTexto = 'VERDADEIRO (Item ' + respostaLabel + ')';
        //                     } else {
        //                          // Se for M√∫ltipla Escolha, a resposta √© a letra
        //                          respostaTexto = respostaLabel;
        //                     }
        //                 }
        //                 altList.appendChild(listItem);
        //             });
        //         }
        //     }

        //     // 5. Atualiza o campo de resposta final e torna o modal vis√≠vel
        //     document.getElementById('detail-answer').textContent = respostaTexto; 
        //     modal.style.display = 'flex';
        // }
        // document.addEventListener('DOMContentLoaded', toggleAlternatives);

        const modal = document.getElementById('details-modal');
        const loadingContainer = document.getElementById('alternativas-loading');
        const alternativesDataContainer = document.getElementById('alternativas-data');
        
        // Substitua sua fun√ß√£o showDetails por esta:
        function showDetails(element) {
            // 1. L√ä OS DADOS B√ÅSICOS DIRETAMENTE DOS ATRIBUTOS DATA-* DO BOT√ÉO
            const id_questao = element.dataset.id;
            const tipo_questao = element.dataset.tipo;
            const enunciado = element.dataset.enunciado;
            const nivel_educacional = element.dataset.nivel;
            const nivel_dificuldade = element.dataset.dificuldade;
            const professor_criador = element.dataset.criador; // ID do Criador

            // NENHUMA VERIFICA√á√ÉO COM questionsData √â NECESS√ÅRIA, eliminando o ReferenceError.

            // 2. Exibe o modal e os dados est√°ticos lidos
            document.getElementById('detail-id').textContent = id_questao;
            document.getElementById('detail-enunciado').textContent = enunciado;
            document.getElementById('detail-tipo').textContent = tipo_questao;
            document.getElementById('detail-nivel').textContent = nivel_educacional;
            document.getElementById('detail-dificuldade').textContent = nivel_dificuldade;
            document.getElementById('detail-criador').textContent = professor_criador; 

           

            alternativesDataContainer.innerHTML = ''; // Limpa conte√∫do anterior
            loadingContainer.style.display = 'block'; // Mostra "Carregando..."
            modal.style.display = 'flex'; // Exibe o modal
            
            console.log("ID da quest√£o:", id_questao);

            // 3. REALIZA A CHAMADA FETCH PARA O BACKEND (para obter apenas as alternativas)
            // const apiUrl = `/questao/${id_questao}/alternativas`;
            // const apiUrl = `"/buscar/${id_questao}"`;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        // Lan√ßa um erro se o status HTTP n√£o for 200 (OK)
                        throw new Error(`Falha no servidor (${response.status}) ao carregar alternativas.`);
                    }
                    return response.json();
                })
                .then(alternatives => {
                    // Sucesso: Esconde loading e injeta os dados
                    loadingContainer.style.display = 'none';
                    // Chama a fun√ß√£o de renderiza√ß√£o com os dados recebidos
                    injectAlternatives(alternatives, tipo_questao);
                })
                .catch(error => {
                    // Erro: Exibe mensagem de erro e loga no console
                    loadingContainer.innerHTML = `<p style="color: var(--danger); font-weight: 600;">Erro ao carregar alternativas: ${error.message}</p>`;
                    console.error('Erro na chamada AJAX:', error);
                });
        }

        /*
         * Pega o array de alternativas do backend (JSON) e renderiza o HTML apropriado
         * dentro do modal de detalhes (id="alternativas-data").
         *
         * O JSON de alternativa deve seguir o modelo:
         * { texto_alternativa: '...', flg_eh_correta: 'S' | 'N' }
         * * @param {Array<Object>} alternatives - A lista de objetos de alternativa (JSON).
         * @param {string} tipo_questao - O tipo da quest√£o (ex: "Multipla Escolha", "Verdadeiro ou Falso").
         */
        function injectAlternatives(alternatives, tipo_questao) {
            const container = document.getElementById('alternativas-data');
            let htmlContent = '';

            // 1. Limpa o conte√∫do anterior
            container.innerHTML = ''; 

            // Garante que haja alternativas para processar
            if (!alternatives || alternatives.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">Nenhuma alternativa encontrada para esta quest√£o.</p>';
                return;
            }

            // --- L√≥gica de Renderiza√ß√£o por Tipo de Quest√£o ---

            // ===================================================
            // 1. M√öLTIPLA ESCOLHA
            // ===================================================
            if (tipo_questao === 'Multipla Escolha') {
                const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
                htmlContent += '<h4 class="detail-subtitle" style="font-weight: 600; font-size: 1.1rem; color: var(--text-light); margin-bottom: 1rem;">Alternativas:</h4>';
                htmlContent += '<ul>';

                alternatives.forEach((alt, index) => {
                    // Verifica se o flag √© 'S' (Sim)
                    const isCorrect = alt.flg_eh_correta === 'S'; 
                    const statusText = isCorrect ? ' (CORRETA)' : '';
                    const colorClass = isCorrect ? 'color: var(--accent); font-weight: 700; border-color: var(--accent);' : 'color: var(--text-light); border-color: transparent;';
                    const bgColor = isCorrect ? '#1f271a' : '#161b22';

                    htmlContent += `
                        <li style="${colorClass} background-color: ${bgColor}; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.95rem; border-width: 1px; border-style: solid;">
                            ${letters[index]}. ${alt.texto_alternativa}${statusText}
                        </li>
                    `;
                });
                htmlContent += '</ul>';
            } 

            // ===================================================
            // 2. VERDADEIRO OU FALSO
            // ===================================================
            else if (tipo_questao === 'Verdadeiro ou Falso') {
                htmlContent += '<h4 class="detail-subtitle" style="font-weight: 600; font-size: 1.1rem; color: var(--text-light); margin-bottom: 1rem;">Afirma√ß√µes e Status:</h4>';
                htmlContent += '<ul>';

                alternatives.forEach((alt, index) => {
                    // Verifica se o flag √© 'S' (Sim)
                    const isTrue = alt.flg_eh_correta === 'S';
                    const statusText = isTrue ? 'VERDADEIRO' : 'FALSO';
                    const statusColor = isTrue ? 'var(--accent)' : 'var(--danger)';
                    const bgColor = isTrue ? '#1f271a' : '#271a1a';

                    htmlContent += `
                        <li style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; background-color: ${bgColor}; padding: 10px; border-radius: 6px; border: 1px solid ${isTrue ? 'var(--accent)' : 'var(--danger)'};">
                            <span style="color: var(--text-light); flex-grow: 1;">Afirma√ß√£o ${index + 1}: ${alt.texto_alternativa}</span>
                            <span style="color: ${statusColor}; font-weight: 700; padding-left: 15px;">
                                ${statusText}
                            </span>
                        </li>
                    `;
                });
                htmlContent += '</ul>';
            }

            // ===================================================
            // 3. PREENCHER LACUNA
            // ===================================================
            else if (tipo_questao === 'Preencher Lacuna') {
                // Assume que a resposta correta (√∫nica) est√° no primeiro item da lista
                const respostaEsperada = alternatives[0]?.texto_alternativa || 'Nenhuma resposta esperada definida.';

                htmlContent += `
                    <h4 class="detail-subtitle" style="font-weight: 600; font-size: 1.1rem; color: var(--text-light); margin-bottom: 1rem;">Resposta Esperada:</h4>
                    <div style="background: #161b22; padding: 12px; border-radius: 8px; font-size: 1rem; color: var(--accent); border: 1px solid var(--accent);">
                        ${respostaEsperada}
                    </div>
                `;
            }
            
            // 4. Injeta o conte√∫do final no DOM
            container.innerHTML = htmlContent;
        }

        function closeDetails() {
            modal.style.display = 'none';
        }

        // 4. Fechar o modal clicando fora
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeDetails();
            }
        });
        
    </script>
</body>
</html>