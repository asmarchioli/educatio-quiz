<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educatio Quiz - Editar Quiz</title>
    
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <link rel="stylesheet" th:href="@{/css/fluxo_professor.css}">
</head>
<body>

    <nav class="navbar">
        <h1>üéì Educatio Quiz - Professor</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span th:text="${professor.nome}"></span>
            <a href="/logout" class="btn-logout">Sair</a>
        </div>
    </nav>
    
        <!-- Mensagens de sucesso e erro -->
        <div th:if="${success}" class="alert alert-success" 
             style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
            <span th:text="${success}"></span>
    
            <button type="button" 
                    onclick="this.parentElement.style.display='none'"
                    style="background: none; border: none; color: #721c24; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
                &times;
            </button>
        </div>
    
        <div th:if="${error}" class="alert alert-danger" 
             style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
            <span th:text="${error}"></span>
    
            <button type="button" 
                    onclick="this.parentElement.style.display='none'"
                    style="background: none; border: none; color: #721c24; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
                &times;
            </button>
        </div>   
    
     <main class="main-content">
        <div class="content-card">

            <div class="quiz-header">
                <!-- T√≠tulo do Quiz  -->
                <h2 class="text-xl font-semibold" style="color: var(--text-light); font-size: 1.5rem;">
                    Quiz: <span th:text="${quiz.titulo}" class="text-accent font-bold text-2xl"></span>
                </h2>

                <!-- Container dos bot√µes principais (Adicionar e Voltar) -->
                <div class="quiz-actions-group">
                    
                    <a th:if="${totalPontos < 100}" 
                       th:href="@{/quiz/banco_questoes(quizId=${quiz.id_quiz})}" 
                       class="btn btn-primary">
                        ‚ûï Quest√£o
                    </a>

                    <button th:if="${totalPontos >= 100}" class="btn btn-secondary" disabled style="opacity: 0.6; cursor: not-allowed;">
                        üîí Limite de 100 pontos atingido
                    </button>
                    
                    <a th:href="@{/quiz/modificar/{id_quiz}(id_quiz = ${quiz.id_quiz})}" class="btn btn-secondary">
                        Editar informa√ß√µes do quiz
                    </a>    
                        
                    <!-- Bot√£o de Voltar/Cancelar -->
                    <a href="/professor/home"         
                        class="btn btn-secondary ">
                        ‚¨ÖÔ∏è Voltar ao √≠nicio 
                    </a>
                </div>
            </div>

            
            <!-- Barra de pesquisa e filtros -->
            <form th:action="@{/quiz/editar/questoes}" method="get" class="filter-bar" style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center;">
                <input type="hidden" name="id_quiz" th:value="${quiz.id_quiz}"/> 
                <!-- Id para o Backend buscar o quix -->
                
                <input type="hidden" name="quizId" th:value="${quizId}"/> 
                <!-- Verifica se est√° vindo do editar quiz -->
                
                <select name="filtroTipo" class="form-input form-select search-filter-select" style="width: 200px;">
                    <option value="">Todos os Tipos</option>

                    <option th:each="tipo : ${tiposQuestao}" 
                            th:value="${tipo.name()}" 
                            th:text="${tipo.displayValue}" 
                            th:selected="${tipo.name() == filtroTipoSelecionado}">
                        Tipo Exemplo
                    </option>
                </select>

                <div class="search-container" style="position: relative; flex-grow: 1;">
                    <input type="text" 
                           name="termoBusca" 
                           th:value="${termoBuscaDigitado}" 
                           placeholder="Buscar enunciado da quest√£o..."
                           class="form-input search-input" 
                           style="width: 100%; padding-left: 35px;">
                </div>

                <button type="submit" class="btn btn-primary" style="padding: 10px 20px; height: 42px;">
                    üîç
                </button>

                <a th:href="@{/quiz/editar/questoes(id_quiz=${quiz.id_quiz})}" class="btn btn-secondary" style="padding: 10px 20px; text-decoration: none; display: flex; align-items: center;">
                    Limpar
                </a>
            </form>
            <!-- T√©rmino da barra de pesquisa -->

            <!-- Pontua√ß√£o total -->
            <div style="background-color: #161b22; 
                            padding: 1.5rem 2rem; 
                            border-radius: var(--radius); 
                            border: 1px solid #2e3542; 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                            margin-bottom: 2rem; 
                            box-shadow: var(--shadow);">

                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 2rem;">üéØ</div> <div>
                            <h3 style="color: var(--text-muted); font-size: 0.9rem; margin: 0; text-transform: uppercase; letter-spacing: 1px;">
                                Pontua√ß√£o Total
                            </h3>

                            <div style="display: flex; align-items: baseline; gap: 5px;">
                                <span style="font-size: 2rem; font-weight: bold;" 
                                      th:styleappend="${totalPontos == 100 ? 'color: var(--accent);' : (totalPontos > 100 ? 'color: var(--danger);' : 'color: var(--text-light);')}"
                                      th:text="${totalPontos}">
                                    0
                                </span>
                                <span style="color: var(--text-muted); font-size: 1.2rem;">/ 100</span>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: right;">

                        <div th:if="${totalPontos == 100}">
                            <span style="color: var(--accent); font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                                ‚úÖ Quiz Completo
                            </span>
                            <small style="color: var(--text-muted);">Pronto para aplica√ß√£o</small>
                        </div>

                        <div th:if="${totalPontos < 100}">
                            <span style="color: var(--warning); font-weight: bold; font-size: 1.1rem;">
                                ‚ö†Ô∏è Em Andamento
                            </span>
                            <div style="color: var(--text-light); margin-top: 4px;">
                                Faltam <strong th:text="${100 - totalPontos}"></strong> pontos para fechar.
                            </div>
                        </div>

                        <div th:if="${totalPontos > 100}">
                            <span style="color: var(--danger); font-weight: bold; font-size: 1.1rem;">
                                ‚õî Excedido
                            </span>
                            <div style="color: var(--text-light); margin-top: 4px;">
                                Remova <strong class="text-danger" th:text="${totalPontos - 100}"></strong> pontos.
                            </div>
                        </div>

                    </div>
                </div>
            
            <div class="table-container"> 
                <table class="dark-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">N¬∞</th>
                            <th style="width: 15%;">Tipo</th>
                            <th style="width: 35%;">Enunciado</th>
                            <th style="width: 10%;">N√≠vel</th>
                            <th class="text-center" style="width: 10%;">Dificuldade</th>

                            <th class="text-center" style="width: 10%;">Pontua√ß√£o</th> 

                            <th class="text-center" style="width: 15%;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tbody>
                            <tr th:each="questao, stat : ${questoes}">

                                <td th:text="${stat.count}">1</td>
                                <td th:text="${questao.tipo_questao}"></td>
                                <td th:text="${questao.enunciado}" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></td>
                                <td th:text="${questao.nivel_educacional}" class="text-center"></td>
                                <td th:text="${questao.nivel_dificuldade}" class="text-center text-accent" ></td>

                                <td class="text-center">
                                    <form th:action="@{/quiz/atualizar/pontuacao}" method="post" 
                                          style="display: flex; align-items: center; justify-content: center; gap: 5px;">

                                        <input type="hidden" name="id_quiz" th:value="${quiz.id_quiz}" />
                                        <input type="hidden" name="id_questao" th:value="${questao.id_questao}" />

                                        <input type="number" name="pontuacao" 
                                               th:value="${questao.pontuacao}" 
                                               min="1" max="100"
                                               class="form-input" 
                                               style="width: 60px; padding: 5px; text-align: center; height: 30px;" />

                                        <button type="submit" class="btn btn-primary" 
                                                style="padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;"
                                                title="Salvar Pontua√ß√£o">
                                            üíæ
                                        </button>
                                    </form>
                                </td>
                                <td class="flex items-center justify-center">
                                    <div class="flex-column-buttons">
                                        <a th:href="@{/questao/buscar(id_questao=${questao.id_questao}, quizId=${quiz.id_quiz})}" 
                                           class="table-action-btn btn-details" 
                                           data-toggle="page">
                                            Detalhes
                                        </a>

                                        <button type="button"
                                                class="table-action-btn btn-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#modalExclusao"
                                                th:data-id="${questao.id_questao}"
                                                style="width:120px;">
                                                üóëÔ∏è
                                        </button>
                                    
                                    </div>
                                </td>
                            </tr>

                            </tbody>

                        <tr id="empty-quiz-row" th:if="${#lists.isEmpty(questoes)}">
                            <td colspan="7" class="text-center" style="color: var(--text-muted); padding: 2rem;">
                                Nenhuma quest√£o adicionada a este quiz. Use o bot√£o acima para adicionar!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Fim da Tabela -->

        </div>
    </main> 

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div class="modal fade" data-bs-theme="dark" id="modalExclusao" tabindex="-1" aria-labelledby="modalExclusaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5 text-danger" id="modalExclusaoLabel">Confirmar Exclus√£o</h1>
                </div>
                <div class="modal-body text-accent"> Tem certeza que deseja excluir esta Quest√£o do Quiz? <br>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

                    <form th:action="@{/quiz/excluir/questao}" method="post">
                        <input type="hidden" name="id_questao" id="idQuestInputHidden" value="" />
                        <input type="hidden" name="id_quiz" th:value="${quiz.id_quiz}" />
                        <button type="submit" class="btn btn-danger">Sim, Excluir</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Script para o modal de exclus√£o
        document.addEventListener('DOMContentLoaded', function () {
            const modalExclusao = document.getElementById('modalExclusao');
            if (modalExclusao) {
                modalExclusao.addEventListener('show.bs.modal', event => {

                    // Bot√£o que aciona o modal
                    const button = event.relatedTarget;

                    // Extrai o ID do atributo data-id
                    const id_questao = button.getAttribute('data-id');

                    // Atualiza o input oculto no formul√°rio do modal
                    const hiddenInput = modalExclusao.querySelector('#idQuestInputHidden');
                    hiddenInput.value = id_questao
                });
            }
        });

        
      
        // Inicializa a p√°gina adicionando o listener de evento de mudan√ßa ao dropdown.
        function initializePage() {
            // Adiciona o listener para o dropdown de tipo de pesquisa
            const searchType = document.getElementById('search-type');
            if (searchType) {
                searchType.addEventListener('change', filterQuestions);
            }
        }

        
       
         
        // Realiza a filtragem das quest√µes na tabela com base no texto e no tipo de busca selecionado.
        function filterQuestions() {
            const input = document.getElementById('search-input');
            
            // Obt√©m o texto do filtro em mai√∫sculas e remove espa√ßos em branco extras
            const filter = input.value.toUpperCase().trim(); 
            const type = document.getElementById('search-type').value; // 'enunciado' ou 'tipo'
            const rows = document.querySelectorAll('.question-row');
            const emptyQuizRow = document.getElementById('empty-quiz-row');
            const noResultsRow = document.getElementById('no-results-row');
            let visibleRows = 0;

            // Oculta a mensagem de quiz vazio (se ela existir) ao iniciar a filtragem
            if (emptyQuizRow) {
                emptyQuizRow.style.display = 'none'; 
            }

            // Caso o filtro esteja vazio, exibe todas as quest√µes e gerencia as mensagens de status
            if (filter.length === 0) {
                rows.forEach(row => {
                    row.style.display = ""; // Mostra a linha
                    visibleRows++;
                });

                // Reexibe a mensagem de quiz vazio apenas se ela foi carregada pelo Thymeleaf (ou seja, lista original estava vazia)
                if (emptyQuizRow) {
                    emptyQuizRow.style.display = ''; 
                }

                noResultsRow.style.display = 'none'; // Oculta a mensagem de nenhum resultado do filtro
                return;
            }


            rows.forEach(row => {
                let cell;

                // Seleciona a c√©lula de busca correta com base no tipo
                if (type === 'enunciado') {
                    cell = row.querySelector('[data-filter-enunciado]');
                } else {
                    cell = row.querySelector('[data-filter-type]');
                }

                if (cell) {
                    const cellValue = cell.textContent || cell.innerText;
                    // Verifica se o valor da c√©lula cont√©m o texto do filtro
                    if (cellValue.toUpperCase().indexOf(filter) > -1) {
                        row.style.display = ""; 
                        visibleRows++;
                    } else {
                        row.style.display = "none"; 
                    }
                } else {
                    // Oculta a linha se, por algum motivo, a c√©lula de filtro n√£o for encontrada
                    row.style.display = "none"; 
                }
            });

            // Gerencia a mensagem de "Nenhuma quest√£o encontrada com este filtro"
            noResultsRow.style.display = visibleRows === 0 ? '' : 'none';
        }

        window.onload = initializePage;
    </script>
</body>
</html>