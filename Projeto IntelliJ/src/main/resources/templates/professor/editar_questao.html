<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Quest√£o</title>
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <link rel="stylesheet" th:href="@{/css/fluxo_professor.css}">
</head>
<body>
    <nav class="navbar">
        <h1>üéì Educatio Quiz - Professor</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span th:text="${professor.nome}"></span>
            <a href="/logout" class="btn-logout">Sair</a>
        </div>
    </nav>

    <div th:if="${error}" class="alert alert-danger" 
         style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
        <span th:text="${error}"></span>
    </div>
    
    <div class="main-content">
        <div class="content-card">

            <h2 class="text-3xl font-bold mb-8 text-center" style="color: var(--accent);"
                th:text="${questao.id_questao == null} ? 'Criar Nova Quest√£o' : 'Editar Quest√£o'">
                Criar/Editar Quest√£o
            </h2>

            <form th:action="${questao.id_questao == null} ? @{/questao/salvar} : @{/questao/atualizar}" 
                  method="post" 
                  th:object="${questao}"
                  id="questionForm">

                <input type="hidden" th:field="*{id_questao}" />
                <input type="hidden" th:field="*{professor_criador}" th:value="${professor.getId_professor()}" />

                <div style="text-align: right; margin-top: 30px;">
                    <a href="javascript:void(0)" onClick="voltarParaBancoQuestoes();return false;" class="btn btn-secondary mr-4">
                        Cancelar
                    </a>
                    
                    <button type="submit" class="btn btn-primary mr-4">
                        Salvar Quest√£o
                    </button>
                </div>

                <div class="form-group">
                    <label for="enunciado" class="form-label">Enunciado da Quest√£o</label>
                    <textarea th:field="*{enunciado}" id="enunciado" class="form-input" rows="4" required placeholder="Digite o enunciado..."></textarea>
                </div>

                <div class="form-group">
                    <label for="tipo_questao" class="form-label">Tipo da Quest√£o</label>
                    <select th:field="*{tipo_questao}" id="tipo_questao" class="form-input" onchange="toggleAlternatives()" required>
                        <option value="">Selecione o Tipo</option>
                        <option th:each="tipo : ${tiposQuestao}" th:value="${tipo}" th:text="${tipo}"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="area" class="form-label">√Årea de Conhecimento</label>
                    <select th:field="*{area}" id="area" required class="form-input" th:disabled="${questao.id_questao != null}">
                        <option value="">Selecione a √Årea</option>
                        <option th:each="areaObj : ${areasProfessor}" 
                                th:value="${areaObj.getIdArea()}" 
                                th:text="${areaObj.getNomeArea()}"
                                th:selected="${questao.area != null AND questao.area == areaObj.getIdArea()}">
                        </option>
                    </select>
                    <input type="hidden" th:if="${questao.id_questao != null}" th:field="*{area}" />
                </div>

                <div class="form-group">
                    <label for="visibilidade" class="form-label">Visibilidade</label>
                    <select th:field="*{visibilidade}" id="visibilidade" class="form-input">
                        <option th:each="visib : ${exibicoes}" th:value="${visib}" th:text="${visib}"></option>
                    </select>
                </div>

                <div class="flex gap-4">
                    <div class="form-group">
                        <label for="quiz-level" class="form-label">
                            N√≠vel Educacional
                        </label>

                        <select id="quiz-level" th:field="*{nivel_educacional}" required class="form-input">
                            <option value="" disabled selected>Selecione o n√≠vel</option>
                            <option th:each= "nivel : ${escolaridades}" th:value="${nivel}" th:text="${nivel}"> </option>
                        </select>
                    </div>

                    <div class="form-group w-1-2">
                        <label for="nivel_dificuldade" class="form-label">Dificuldade</label>
                        <select th:field="*{nivel_dificuldade}" id="nivel_dificuldade" class="form-input" required>
                            <option th:each="dificuldade : ${dificuldades}" th:value="${dificuldade}" th:text="${dificuldade}"></option>
                        </select>
                    </div>
                </div>

                
                <div id="multipla-escolha-section" style="display:none; padding: 15px; 
                        border: 1px dashed #2e3542; border-radius: 8px; margin-top: 20px;"
                     class="alternativas-section">
                    
                    <h3 style="color: var(--accent); font-size: 1.1rem; 
                        margin-bottom: 10px;">
                        Alternativas (M√∫ltipla Escolha)
                    </h3>
                    <p class="text-muted mb-4" style="font-size: 0.9rem;">
                        Adicione as op√ß√µes e selecione a "bolinha" da alternativa correta.
                    </p>

                    <div id="alternativas-container-mc">
                        <div th:each="alt, stat : *{alternativas}" class="alternativa-item" 
                            th:attr="data-index=${stat.index}" style="margin-bottom: 20px; 
                            padding-bottom: 10px; border-bottom: 1px solid #161b22;">

                            <div class="flex gap-2 items-center mb-1">
                                <input type="text" 
                                    th:field="*{alternativas[__${stat.index}__].texto_alternativa}" 
                                    class="form-input flex-grow" 
                                    placeholder="Preencha o enunciado da Alternativa" required>

                                <button type="button" class="btn-danger" onclick="removerAlternativa(this)" 
                                    style="width:30; height: 35; border-radius:10px">
                                    üóëÔ∏è
                                </button>
                            </div>

                            <div class="alternativa-action-group flex items-center justify-start">
                                <input type="radio" name="mc_selection_group" th:value="${stat.index}" 
                                       th:checked="${alt.flg_eh_correta == 'S'}" 
                                       style="width: 20px; height: 20px; margin-top: 10px">
                                <label style="color: var(--accent); font-weight: 600; margin-right: 1rem; margin-top: 10px">Correta</label>
                            </div>

                            <input type="hidden" th:field="*{alternativas[__${stat.index}__].flg_eh_correta}" class="flag-correta">
                            <input type="hidden" th:field="*{alternativas[__${stat.index}__].num_alternativa}">
                        </div>
                    </div>

                    <button type="button" onclick="adicionarAlternativa('mc')" class="btn btn-primary mt-4">‚ûï Nova Alternativa</button>
                </div>

                <!-- SE√á√ÉO VERDADEIRO OU FALSO -->
                <!-- SE√á√ÉO VERDADEIRO/FALSO - VERS√ÉO CORRIGIDA -->
                <div id="verdadeiro-falso-section" 
                     style="display:none; padding: 15px; border: 1px dashed #2e3542; 
                            border-radius: 8px; margin-top: 20px;"
                     class="alternativas-section">

                    <h3 style="color: var(--accent); font-size: 1.1rem; margin-bottom: 10px;">
                        Resposta (Verdadeiro ou Falso)
                    </h3>
                    <p class="text-muted mb-3" style="font-size: 0.9rem;">
                        Selecione qual √© a resposta correta para o enunciado: 
                    </p>

                    <!-- Radio buttons para selecionar V ou F -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" 
                                   name="vf_selection" 
                                   value="V" 
                                   class="vf-radio-verdadeiro"
                                   style="width: 20px; height: 20px; margin-right: 10px;">
                            <span style="color: var(--accent); font-weight: 600;">Verdadeiro (V)</span>
                        </label>

                        <label style="display: block;">
                            <input type="radio" 
                                   name="vf_selection" 
                                   value="F" 
                                   class="vf-radio-falso"
                                   style="width: 20px; height: 20px; margin-right: 10px;">
                            <span style="color: var(--accent); font-weight: 600;">Falso (F)</span>
                        </label>
                    </div>

                    <!-- Alternativa 1: "Verdadeiro" -->
                    <input type="hidden" 
                           th:field="*{alternativas[0].texto_alternativa}" 
                           value="Verdadeiro">
                    <input type="hidden" 
                           th:field="*{alternativas[0].flg_eh_correta}" 
                           class="vf-flag-verdadeiro">
                    <input type="hidden" 
                           th:field="*{alternativas[0].num_alternativa}" 
                           value="1">

                    <!-- Alternativa 2: "Falso" -->
                    <input type="hidden" 
                           th:field="*{alternativas[1].texto_alternativa}" 
                           value="Falso">
                    <input type="hidden" 
                           th:field="*{alternativas[1].flg_eh_correta}" 
                           class="vf-flag-falso">
                    <input type="hidden" 
                           th:field="*{alternativas[1].num_alternativa}" 
                           value="2">
                </div>

                
                <div id="preencher-lacuna-section" 
                     class="alternativas-section"
                    style="display:none; padding: 15px; border: 1px dashed #2e3542; 
                    border-radius: 8px; margin-top: 20px">
                    <div class="form-group">
                        <label for="resposta_lacuna" class="form-label">Resposta Exata da Lacuna</label>
                        <textarea id="resposta_lacuna" 
                                  th:field="*{alternativas[0].texto_alternativa}"
                                  rows="2" class="form-input" 
                                  placeholder="Palavra exata esperada..."></textarea>
                        <input type="hidden" name="alternativas[0].flg_eh_correta" value="S">
                        <input type="hidden" name="alternativas[0].num_alternativa" value="1">
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script>
        // =====================================================
        // JAVASCRIPT COMPLETO E CORRIGIDO PARA editar_questao.html
        // =====================================================

        // 1. Gerenciamento de Exibi√ß√£o de Se√ß√µes
        function toggleAlternatives() {
            const tipoElement = document.getElementById('tipo_questao');
            if (!tipoElement) return;

            const tipo = tipoElement.value;
            console.log('Tipo Selecionado:', tipo); 

            const mc = document.getElementById('multipla-escolha-section');
            const vf = document.getElementById('verdadeiro-falso-section');
            const lacuna = document.getElementById('preencher-lacuna-section');

            // Oculta todas as se√ß√µes
            if(mc) mc.style.display = 'none';
            if(vf) vf.style.display = 'none';
            if(lacuna) lacuna.style.display = 'none';

            // Exibe a se√ß√£o correspondente ao tipo selecionado
            if (tipo === 'MULTIPLA_ESCOLHA' || tipo === 'Multipla Escolha' || tipo === 'M√∫ltipla Escolha') {
                if(mc) mc.style.display = 'block';
            } 
            else if (tipo === 'VERDADEIRO_FALSO' || tipo === 'Verdadeiro ou Falso' || tipo === 'VerdadeiroFalso') {
                if(vf) vf.style.display = 'block';
            } 
            else if (tipo === 'PREENCHER_LACUNA' || tipo === 'Preencher Lacuna') {
                if(lacuna) lacuna.style.display = 'block';
            }
        }

        // 2. Adicionar Nova Alternativa (apenas M√∫ltipla Escolha)
        function adicionarAlternativa(tipo) {
            if (tipo !== 'mc') return;

            const container = document.getElementById('alternativas-container-mc');
            const nextIndex = container.querySelectorAll('.alternativa-item').length;

            const html = `
            <div class="alternativa-item" data-index="${nextIndex}" style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #161b22;">
                <div class="flex gap-2 items-center mb-1">
                    <input type="text" 
                           name="alternativas[${nextIndex}].texto_alternativa" 
                           class="form-input flex-grow" 
                           placeholder="Preencha o enunciado da Alternativa" 
                           required>
                    <button type="button" 
                            class="btn-danger" 
                            onclick="removerAlternativa(this)" 
                            style="width:30px; height: 35px; border-radius:10px">
                        üóëÔ∏è
                    </button>
                </div>

                <div class="alternativa-action-group flex items-center justify-start">
                    <input type="radio" 
                           name="mc_selection_group" 
                           value="${nextIndex}" 
                           style="width: 20px; height: 20px; margin-top: 10px">
                    <label style="color: var(--accent); font-weight: 600; margin-right: 1rem; margin-top: 10px">
                        Correta
                    </label>
                </div>

                <input type="hidden" 
                       name="alternativas[${nextIndex}].flg_eh_correta" 
                       value="N" 
                       class="flag-correta">
                <input type="hidden" 
                       name="alternativas[${nextIndex}].num_alternativa" 
                       value="${nextIndex + 1}">
            </div>`;

            container.insertAdjacentHTML('beforeend', html);
        }

        // 3. Remover Alternativa
        function removerAlternativa(btn) {
            const item = btn.closest('.alternativa-item');
            const container = item.parentNode;

            if (container.id === 'alternativas-container-mc') {
                const totalItems = container.querySelectorAll('.alternativa-item').length;

                if (totalItems > 1) {
                    item.remove();
                    reindexar(container);
                } else {
                    alert("M√∫ltipla Escolha deve ter pelo menos uma alternativa.");
                }
            }
        }

        // 4. Reindexar alternativas ap√≥s remo√ß√£o
        function reindexar(container) {
            const items = container.querySelectorAll('.alternativa-item');

            items.forEach((item, index) => {
                // Atualiza o atributo data-index
                item.setAttribute('data-index', index);

                // Atualiza todos os inputs
                const inputs = item.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    // Atualiza o name (CR√çTICO para Spring Boot)
                    if (input.name) {
                        input.name = input.name.replace(/alternativas\[\d+\]/, `alternativas[${index}]`);
                    }

                    // Atualiza o id
                    if (input.id) {
                        input.id = input.id.replace(/\d+$/, index);
                    }
                });

                // Atualiza o valor do r√°dio
                const radioMC = item.querySelector('input[name="mc_selection_group"]');
                if (radioMC) {
                    radioMC.value = index;
                }

                // Atualiza o n√∫mero sequencial
                const hiddenNum = item.querySelector('input[name$="num_alternativa"]');
                if (hiddenNum) {
                    hiddenNum.value = index + 1;
                }
            });
        }

        // 5. Evento de Submit do Formul√°rio
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('questionForm');

            if (!form) return;

            form.addEventListener('submit', function(e) {
                const tipo = document.getElementById('tipo_questao').value;

                // Identifica a se√ß√£o ativa
                let activeSectionId = '';
                if (tipo === 'MULTIPLA_ESCOLHA' || tipo === 'Multipla Escolha' || tipo === 'M√∫ltipla Escolha') {
                    activeSectionId = 'multipla-escolha-section';
                } else if (tipo === 'VERDADEIRO_FALSO' || tipo === 'Verdadeiro ou Falso') {
                    activeSectionId = 'verdadeiro-falso-section';
                } else if (tipo === 'PREENCHER_LACUNA' || tipo === 'Preencher Lacuna') {
                    activeSectionId = 'preencher-lacuna-section';
                }

                // Desabilita TODOS os inputs primeiro
                const allSections = document.querySelectorAll('.alternativas-section');
                allSections.forEach(section => {
                    const inputs = section.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.disabled = true; 
                    });
                });

                // Processa a se√ß√£o ativa
                if (activeSectionId) {
                    const activeSection = document.getElementById(activeSectionId);

                    // ESPEC√çFICO PARA VERDADEIRO/FALSO
                    if (activeSectionId === 'verdadeiro-falso-section') {
                        const radios = document.getElementsByName('vf_selection');
                        const flagVerdadeiro = document.querySelector('.vf-flag-verdadeiro');
                        const flagFalso = document.querySelector('.vf-flag-falso');

                        // Verifica qual r√°dio est√° marcado e atualiza as flags
                        let selectedValue = '';
                        for (let i = 0; i < radios.length; i++) {
                            if (radios[i].checked) {
                                selectedValue = radios[i].value;
                                break;
                            }
                        }

                        if (selectedValue === 'V') {
                            flagVerdadeiro.value = 'S';
                            flagFalso.value = 'N';
                        } else if (selectedValue === 'F') {
                            flagVerdadeiro.value = 'N';
                            flagFalso.value = 'S';
                        } else {
                            // Se nenhum foi selecionado, previne o submit
                            e.preventDefault();
                            alert("Selecione se a resposta √© Verdadeiro ou Falso.");

                            // Reabilita inputs
                            allSections.forEach(section => {
                                const inputs = section.querySelectorAll('input, select, textarea');
                                inputs.forEach(input => input.disabled = false);
                            });
                            return;
                        }
                    }

                    // ESPEC√çFICO PARA M√öLTIPLA ESCOLHA
                    else if (activeSectionId === 'multipla-escolha-section') {
                        const items = activeSection.querySelectorAll('.alternativa-item');

                        // Remove alternativas com texto vazio
                        items.forEach(item => {
                            const textoInput = item.querySelector('input[name*="texto_alternativa"]');
                            if (textoInput && (!textoInput.value || textoInput.value.trim() === '')) {
                                item.remove();
                            }
                        });

                        // Reindexar ap√≥s remo√ß√£o
                        const container = document.getElementById('alternativas-container-mc');
                        reindexar(container);

                        // Valida√ß√£o: pelo menos uma alternativa
                        const remainingItems = activeSection.querySelectorAll('.alternativa-item');
                        if (remainingItems.length === 0) {
                            e.preventDefault();
                            alert("Adicione pelo menos uma alternativa.");

                            // Reabilita inputs para corre√ß√£o
                            allSections.forEach(section => {
                                const inputs = section.querySelectorAll('input, select, textarea');
                                inputs.forEach(input => input.disabled = false);
                            });
                            return;
                        }

                        // Valida√ß√£o: uma deve estar marcada como correta
                        const radios = document.getElementsByName('mc_selection_group');
                        let selecionado = false;
                        for (let i = 0; i < radios.length; i++) {
                            if (radios[i].checked) { 
                                selecionado = true; 
                                break; 
                            }
                        }

                        if (!selecionado) {
                            e.preventDefault();
                            alert("Selecione qual √© a alternativa correta.");

                            // Reabilita inputs para corre√ß√£o
                            allSections.forEach(section => {
                                const inputs = section.querySelectorAll('input, select, textarea');
                                inputs.forEach(input => input.disabled = false);
                            });
                            return; 
                        }

                        // Atualiza flags ocultas baseado nos r√°dios
                        remainingItems.forEach(item => {
                            const radio = item.querySelector('input[name="mc_selection_group"]');
                            const hiddenFlag = item.querySelector('.flag-correta');
                            if (radio && hiddenFlag) {
                                hiddenFlag.value = radio.checked ? 'S' : 'N';
                            }
                        });
                    }

                    // Reabilita APENAS os inputs da se√ß√£o ativa
                    const validInputs = activeSection.querySelectorAll('input, select, textarea');
                    validInputs.forEach(input => {
                        input.disabled = false;
                    });
                }
            });
        });

        // 6. Inicializa√ß√£o e limpeza ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // ========================================================
            // PARTE A: Inicializar M√öLTIPLA ESCOLHA
            // ========================================================
            const containerMC = document.getElementById('alternativas-container-mc');
            if (containerMC) {
                const items = containerMC.querySelectorAll('.alternativa-item');

                // Passo 1: Limpar vazios (opcional, mas recomendado)
                items.forEach(item => {
                    const textoInput = item.querySelector('input[name*="texto_alternativa"]');
                    if (textoInput && (!textoInput.value || textoInput.value.trim() === '')) {
                        item.remove();
                    }
                });

                // Passo 2: Reindexar e Marcar R√°dio Correto
                const remainingItems = containerMC.querySelectorAll('.alternativa-item');
                if (remainingItems.length > 0) {
                    reindexar(containerMC); // Garante que √≠ndices [0], [1] est√£o certos

                    remainingItems.forEach((item, index) => {
                        // Encontra a flag vinda do banco (S ou N)
                        const hiddenFlag = item.querySelector('.flag-correta'); 
                        // Encontra o r√°dio visual
                        const radio = item.querySelector('input[name="mc_selection_group"]');

                        // Se a flag for 'S', marca o r√°dio!
                        if (hiddenFlag && radio && hiddenFlag.value === 'S') {
                            radio.checked = true;
                        }

                        // Garante que o valor do r√°dio bata com o √≠ndice atual
                        if (radio) radio.value = index;
                    });
                }
            }

            // Precisamos ler as flags ocultas (vf-flag-verdadeiro e vf-flag-falso)
            // e marcar o r√°dio visual correspondente (V ou F)
            const flagVerdadeiro = document.querySelector('.vf-flag-verdadeiro');
            const radioVerdadeiro = document.querySelector('.vf-radio-verdadeiro');
            const radioFalso = document.querySelector('.vf-radio-falso');

            if (flagVerdadeiro && radioVerdadeiro && radioFalso) {
                // Se a Alternativa 1 (Verdadeiro) tem flag 'S', ent√£o a resposta √© VERDADEIRO
                if (flagVerdadeiro.value === 'S') {
                    radioVerdadeiro.checked = true;
                } 
                // Se a Alternativa 1 (Verdadeiro) tem flag 'N', ent√£o a resposta √© FALSO
                else if (flagVerdadeiro.value === 'N') {
                    radioFalso.checked = true;
                }
            }

            // Exibe a se√ß√£o correta baseada no tipo selecionado
            toggleAlternatives();
        });

        // 7. Fun√ß√£o de navega√ß√£o (voltar)
        function voltarParaBancoQuestoes() {
            history.back();
        }
    </script>
</body>
</html>