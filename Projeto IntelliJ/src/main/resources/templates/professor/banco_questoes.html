<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educatio Quiz - Gerenciamento de Quest√µes</title>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" th:href="@{/css/global.css}">
    <link rel="stylesheet" th:href="@{/css/fluxo_professor.css}">
</head>
<body>
    <nav class="navbar">
        <h1>üéì Educatio Quiz - Professor</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span th:text="${professor.nome}"></span>
            <a href="/logout" class="btn-logout">Sair</a>
        </div>
    </nav>


    <div th:if="${success}" class="alert alert-success" 
         style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
        <span th:text="${success}"></span>

        <button type="button" 
                onclick="this.parentElement.style.display='none'"
                style="background: none; border: none; color: #721c24; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
            &times;
        </button>
    </div>

    <div th:if="${error}" class="alert alert-danger" 
         style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
        <span th:text="${error}"></span>

        <button type="button" 
                onclick="this.parentElement.style.display='none'"
                style="background: none; border: none; color: #721c24; font-size: 1.2rem; font-weight: bold; cursor: pointer;">
            &times;
        </button>
    </div>


    <main class="main-content">
        <div class="content-card">

            <!-- T√≠tulo da √Årea e Bot√£o de Cria√ß√£o -->
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-semibold" style="color: var(--text-light);">
                    Gerenciamento de Quest√µes
                </h2>
                
                <div th:if="${quizId == null}">
                    <!-- Bot√£o de Voltar/Cancelar -->
                    <a href="/professor/home"         
                        class="btn btn-secondary ">
                        ‚¨ÖÔ∏è Voltar para Menu Inicial
                    </a>
                
                    <!-- Bot√£o de Cria√ß√£o -->
                    <a href="/questao/novo" class="btn btn-primary font-semibold">
                    <!-- <a href="/professor/criar_questao" class="btn btn-primary font-semibold"> -->
                        ‚ûï Criar Nova Quest√£o
                    </a>
                </div>
                
                <div th:if="${quizId != null}">
                    <!-- Bot√£o de Voltar/Cancelar -->
                    <a th:href="@{/quiz/editar/questoes(id_quiz=${quizId})}"         
                        class="btn btn-secondary ">
                        ‚¨ÖÔ∏è Voltar para Edi√ß√£o de Quiz
                    </a>
                </div>
            </div>

            

            
            <form th:action="@{/questao/listar/questoes}" method="get" class="filter-bar" style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center;">

                <input type="hidden" th:name="id_prof" th:value="${professor.id_professor}" />
                <input type="hidden" th:name="quizId" th:value="${quizId}" />

                <div th:if="${quizId != null}" style="margin-right: 10px;">
                    <select name="modoBusca" class="form-input form-select search-filter-select" style="width: 200px;">
                        <option value="MEUS" th:selected="${modoBuscaSelecionado == 'MEUS'}">
                            üë§ Minhas Quest√µes
                        </option>
                        <option value="COMPATIVEL" th:selected="${modoBuscaSelecionado == 'COMPATIVEL'}">
                            üåé Banco P√∫blico (Mesma √Årea/N√≠vel)
                        </option>
                    </select>
                </div>
                
                <select name="filtroTipo" class="form-input form-select search-filter-select" style="width: 200px;">
                    <option value="">Todos os Tipos</option>

                    <option th:each="tipo : ${tiposQuestao}" 
                            th:value="${tipo.name()}" 
                            th:text="${tipo.displayValue}" 
                            th:selected="${tipo.name() == filtroTipoSelecionado}">
                        Tipo Exemplo
                    </option>
                </select>

                <div class="search-container" style="position: relative; flex-grow: 1;">
                    <input type="text" 
                           name="termoBusca" 
                           th:value="${termoBuscaDigitado}" 
                           placeholder="Buscar enunciado da quest√£o..."
                           class="form-input search-input" 
                           style="width: 100%; padding-left: 25px;">
                </div>

                <button type="submit" class="btn btn-primary" style="padding: 10px 20px; height: 42px;">
                    üîç
                </button>

                <a th:href="@{/questao/listar/questoes(id_prof=${professor.id_professor}, quizId=${quizId})}" class="btn btn-secondary" style="padding: 10px 20px; text-decoration: none; display: flex; align-items: center;">
                    Limpar
                </a>

            </form>

            <!-- Tabela Responsiva de Quest√µes -->
            <div class="table-container">
                <table class="dark-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">Tipo</th>
                            <th style="width: 45%;">Enunciado</th>
                            <th style="width: 15%;">N√≠vel</th>
                            <th class="text-center" style="width: 10%;">Dificuldade</th>
                            <th class="text-center" style="width: 15%;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="questao : ${questoes}">
                            <td th:text="${questao.tipo_questao}"></td>
                            <td th:text="${questao.enunciado}"
                                style="max-width: 350px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                
                            </td>
                            <td th:text="${questao.nivel_educacional}" class="text-center"></td>
                            <td th:text="${questao.nivel_dificuldade}" class="text-center text-accent" ></td>

                            <!-- Bot√µes de a√ß√£o  -->
                            <td class="flex items-center space-y-1">

                                <!-- Se vier do editar quiz, ent√£o aparece o bot√£o de adicionar quest√£o ao quiz  -->
                                <div th:if="${quizId != null}" class="flex-column-buttons">
                                    <form th:action="@{/quiz/adicionar/questao}" method="post" class="inline-block"> 
                                        <input type="hidden" name="id_questao" th:value="${questao.id_questao}" />
                                        <input type="hidden" name="id_quiz" th:value="${quizId}" />
                                        
                                        <button type="submit" class="table-action-btn btn-primary" style="width:90px">
                                            ‚ûï
                                        </button>
                                    </form>

                                   <!-- inline-block √© para pegar o style do flex-column -->
                                    <form th:action="@{/questao/buscar}" class="inline-block" method="get">
                                        <input type="hidden" name="id_questao" th:value="${questao.id_questao}" />
                                        <input type="hidden" name="quizId" th:value="${quizId}" />
                                        <button type="submit" class="table-action-btn btn-details"> ‚ÑπÔ∏è </button>
                                    </form>
                    
                                </div>

                                <!-- Se vier do banco de questoes do professor usu√°rio  -->
                                <div th:if="${quizId == null}" class="flex-column-buttons"> 

                                    <a th:href="@{/questao/buscar(id_questao=${questao.id_questao})}"
                                       class="table-action-btn btn-details"
                                       data-toggle="page">
                                        Detalhes
                                    </a>

                                    <a th:href="@{/questao/editar/{id}(id=${questao.getId_questao()})}"
                                       class="table-action-btn btn-edit">
                                        Editar
                                    </a>

                
                                    <button type="button" 
                                            class="table-action-btn btn-danger-table"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalExclusao"
                                            th:data-id="${questao.id_questao}">
                                        Excluir
                                    </button>
                           

                                </div>
                            </td>
                        </tr>

                        <!-- Linha de Mensagem de Filtro Vazio (Controlada pelo JS) -->
                        <tr th:if="${#lists.isEmpty(questoes)}">
                            <td colspan="6" class="text-center" style="color: var(--text-muted); padding: 2rem;">
                                Nenhuma quest√£o encontrada com este filtro.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Fim da Tabela -->

        </div>
    </main>

    <div class="modal fade" data-bs-theme="dark" id="modalExclusao" tabindex="-1" aria-labelledby="modalExclusaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5 text-danger" id="modalExclusaoLabel">Confirmar Exclus√£o</h1>
                </div>
                <div class="modal-body text-accent"> Tem certeza que deseja excluir esta quest√£o do Quiz? <br><br>
                    <span style="color: var(--danger);"> Esta a√ß√£o: </span><br>
                    <span style="color: var(--danger-light);"> - Excluir√° todas as respostas dos alunos </span><br>
                    <span style="color: var(--danger-light);"> - Excluir√° a quest√£o de todos os Quizzes em que estiver </span>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

                    <form th:action="@{/questao/excluir}" method="post">
                        <input type="hidden" name="id_questao" id="idQuestInputHidden" value="" />
                        <button type="submit" class="btn btn-danger">Sim, Excluir</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modalExclusao = document.getElementById('modalExclusao');
            if (modalExclusao) {
                modalExclusao.addEventListener('show.bs.modal', event => {
                    
                    // Bot√£o que acionou o modal
                    const button = event.relatedTarget;
                    
                    // Extrai o ID do atributo data-id
                    const id_questao = button.getAttribute('data-id');
                    
                    // Atualiza o input oculto no formul√°rio do modal
                    const hiddenInput = modalExclusao.querySelector('#idQuestInputHidden');
                    hiddenInput.value = id_questao
                });
            }
        });
    </script>
</body>
</html>